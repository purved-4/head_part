<div
  id="webcrumbs"
  class="max-w-7xl mx-auto p-6 bg-[var(--color-surface)] rounded-xl shadow-sm border border-[var(--color-border)]"
>
  <!-- Header Section -->
  <div
    class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6"
  >
    <div class="flex items-center gap-3">
      <div
        class="w-10 h-10 bg-[var(--color-primary)] rounded-lg flex items-center justify-center"
      >
        <span class="material-icons text-white text-xl">
          account_balance_wallet
        </span>
      </div>
      <div>
        <h1 class="text-xl font-bold text-[var(--color-font)]">Manage UPIs</h1>
        <p class="text-[var(--color-muted)] text-sm">
          Manage UPI QR codes and their status
        </p>
      </div>
    </div>
    <button
      (click)="openAddModal()"
      class="inline-flex items-center px-4 py-2.5 bg-[var(--color-primary)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary-dark)] transition-colors duration-200"
    >
      <span class="material-icons mr-2">add</span>
      Add New UPI
    </button>
  </div>

  <div
    class="bg-[var(--color-bg)] rounded-lg p-4 mb-6 border border-[var(--color-border)]"
  >
    <h3
      class="text-base font-semibold text-[var(--color-font)] mb-3 flex items-center"
    >
      <span class="material-icons mr-2 text-[var(--color-primary)]">
        filter_list
      </span>
      Filter UPIs
    </h3>

    <!-- Main Filters Row -->
    <div
      class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 mb-4"
    >
      <!-- Search Input -->
      <div class="relative flex-1 max-w-md">
        <span
          class="material-icons absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--color-muted)]"
        >
          search
        </span>
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearch()"
          placeholder="Search by Website or UPI ID..."
          class="pl-10 pr-4 py-2.5 w-full border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition-colors duration-200 bg-[var(--color-surface)]"
        />
      </div>

      <!-- Website Filter with Searchable Dropdown -->
      <div class="relative flex-1 max-w-md website-filter-container">
        <span
          class="material-icons absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--color-muted)]"
        >
          language
        </span>
        <input
          type="text"
          [(ngModel)]="websiteSearchTerm"
          (ngModelChange)="filterWebsites()"
          (focus)="showWebsiteDropdown = true"
          (blur)="onWebsiteInputBlur()"
          placeholder="Search or select website..."
          class="pl-10 pr-4 py-2.5 w-full border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] transition-colors duration-200 bg-[var(--color-surface)]"
        />
        <!-- Website Dropdown -->
        <div
          *ngIf="showWebsiteDropdown && filteredWebsites.length > 0"
          class="absolute z-50 w-full mt-1 bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg shadow-lg max-h-60 overflow-y-auto"
        >
          <div
            *ngFor="let website of filteredWebsites"
            (mousedown)="selectWebsite(website)"
            class="px-4 py-2 hover:bg-[var(--color-hover)] cursor-pointer transition-colors duration-200 border-b border-[var(--color-border)] last:border-b-0"
          >
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="font-medium text-[var(--color-font)]">
                  {{ website.domain }}
                </div>
                <div
                  class="text-xs text-[var(--color-muted)] flex items-center mt-1"
                >
                  <span class="material-icons mr-1 text-xs"
                    >currency_exchange</span
                  >
                  {{ website.currency }}
                </div>
              </div>
              <span
                *ngIf="selectedWebsite?.id === website.id"
                class="material-icons text-[var(--color-primary)] text-sm ml-2"
              >
                check
              </span>
            </div>
          </div>
          <div
            *ngIf="filteredWebsites.length === 0"
            class="px-4 py-3 text-center text-[var(--color-muted)] text-sm"
          >
            No websites found
          </div>
        </div>
        <!-- Clear selection button -->
        <button
          *ngIf="selectedWebsite"
          (mousedown)="clearWebsiteFilter()"
          class="absolute right-3 top-1/2 transform -translate-y-1/2 p-1 hover:bg-[var(--color-hover)] rounded-full transition-colors"
          title="Clear website filter"
        >
          <span class="material-icons text-[var(--color-danger)] text-sm">
            close
          </span>
        </button>
      </div>

      <!-- Status Filter -->
      <select
        [(ngModel)]="filterStatus"
        (change)="onSearch()"
        class="px-3 py-2.5 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] bg-[var(--color-surface)] transition-colors duration-200 font-medium text-[var(--color-font)] text-sm min-w-[140px]"
      >
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>

    <!-- Amount Filter Dropdown Button -->
    <div class="mb-4">
      <button
        type="button"
        (click)="showAmountFilter = !showAmountFilter"
        class="inline-flex items-center px-4 py-2 bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg hover:bg-[var(--color-hover)] transition-colors duration-200 font-medium text-[var(--color-font)]"
      >
        <span class="material-icons mr-2 text-[var(--color-primary)]">
          filter_alt
        </span>
        Amount Filter
        <span class="material-icons ml-2">
          {{ showAmountFilter ? "expand_less" : "expand_more" }}
        </span>
      </button>

      <!-- TWO Amount Filters Content -->
      <div
        *ngIf="showAmountFilter"
        class="mt-3 p-4 border border-[var(--color-border)] rounded-lg bg-[var(--color-surface)]"
      >
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- 1. Limit Amount Filter -->
          <div>
            <label
              class="block text-sm font-medium text-[var(--color-font)] mb-2"
            >
              Limit Amount (₹)
            </label>
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-2">
                <input
                  type="number"
                  [(ngModel)]="limitMinAmount"
                  (ngModelChange)="onAmountFilterChange()"
                  placeholder="Min ₹"
                  min="0"
                  step="1"
                  class="flex-1 px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] bg-[var(--color-bg)] transition-colors duration-200 text-sm"
                />
                <span class="text-[var(--color-muted)]">to</span>
                <input
                  type="number"
                  [(ngModel)]="limitMaxAmount"
                  (ngModelChange)="onAmountFilterChange()"
                  placeholder="Max ₹"
                  min="0"
                  step="1"
                  class="flex-1 px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] bg-[var(--color-bg)] transition-colors duration-200 text-sm"
                />
              </div>
              <div
                *ngIf="limitFilterActive"
                class="text-xs text-[var(--color-muted)]"
              >
                Filtering Limit: {{ limitMinAmount || 0 }} -
                {{ limitMaxAmount || "∞" }} ₹
              </div>
            </div>
          </div>

          <!-- 2. Transaction Range Filter -->
          <div>
            <label
              class="block text-sm font-medium text-[var(--color-font)] mb-2"
            >
              Transaction Range (₹)
              <span class="text-xs text-[var(--color-muted)] ml-1">
                (Applies to Min & Max amounts)
              </span>
            </label>
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-2">
                <input
                  type="number"
                  [(ngModel)]="transactionMinAmount"
                  (ngModelChange)="onAmountFilterChange()"
                  placeholder="Min ₹"
                  min="0"
                  step="1"
                  class="flex-1 px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] bg-[var(--color-bg)] transition-colors duration-200 text-sm"
                />
                <span class="text-[var(--color-muted)]">to</span>
                <input
                  type="number"
                  [(ngModel)]="transactionMaxAmount"
                  (ngModelChange)="onAmountFilterChange()"
                  placeholder="Max ₹"
                  min="0"
                  step="1"
                  class="flex-1 px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] bg-[var(--color-bg)] transition-colors duration-200 text-sm"
                />
              </div>
              <div
                *ngIf="transactionFilterActive"
                class="text-xs text-[var(--color-muted)]"
              >
                Filtering Min/Max: {{ transactionMinAmount || 0 }} -
                {{ transactionMaxAmount || "∞" }} ₹
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div
      class="flex flex-col sm:flex-row items-center justify-between gap-3 pt-3 border-t border-[var(--color-border)]"
    >
      <div
        class="text-sm text-[var(--color-muted)] flex flex-wrap items-center gap-2"
      >
        <!-- Active Filters Display -->
        <div
          *ngIf="selectedWebsite"
          class="inline-flex items-center bg-[var(--color-primary)]/10 text-[var(--color-primary)] px-3 py-1 rounded-full"
        >
          <span class="material-icons mr-1 text-sm">language</span>
          {{ selectedWebsite.domain }}
          <button
            (click)="clearWebsiteFilter()"
            class="ml-2 hover:text-[var(--color-danger)] transition-colors"
          >
            <span class="material-icons text-sm">close</span>
          </button>
        </div>

        <!-- Status Filter Badge -->
        <div
          *ngIf="filterStatus"
          class="inline-flex items-center bg-[var(--color-primary)]/10 text-[var(--color-primary)] px-3 py-1 rounded-full"
        >
          <span class="material-icons mr-1 text-sm">toggle_on</span>
          {{ filterStatus === "active" ? "Active" : "Inactive" }}
          <button
            (click)="filterStatus = ''; onSearch()"
            class="ml-2 hover:text-[var(--color-danger)] transition-colors"
          >
            <span class="material-icons text-sm">close</span>
          </button>
        </div>

        <!-- Search Term Badge -->
        <div
          *ngIf="searchTerm"
          class="inline-flex items-center bg-[var(--color-primary)]/10 text-[var(--color-primary)] px-3 py-1 rounded-full"
        >
          <span class="material-icons mr-1 text-sm">search</span>
          "{{ searchTerm }}"
          <button
            (click)="searchTerm = ''; onSearch()"
            class="ml-2 hover:text-[var(--color-danger)] transition-colors"
          >
            <span class="material-icons text-sm">close</span>
          </button>
        </div>

        <!-- Limit Amount Filter Badge -->
        <div
          *ngIf="limitFilterActive"
          class="inline-flex items-center bg-[var(--color-primary)]/10 text-[var(--color-primary)] px-3 py-1 rounded-full"
        >
          <span class="material-icons mr-1 text-sm">currency_rupee</span>
          Limit: {{ limitMinAmount || "0" }} - {{ limitMaxAmount || "∞" }} ₹
          <button
            (click)="clearLimitFilter()"
            class="ml-2 hover:text-[var(--color-danger)] transition-colors"
          >
            <span class="material-icons text-sm">close</span>
          </button>
        </div>

        <!-- Transaction Range Filter Badge -->
        <div
          *ngIf="transactionFilterActive"
          class="inline-flex items-center bg-[var(--color-primary)]/10 text-[var(--color-primary)] px-3 py-1 rounded-full"
        >
          <span class="material-icons mr-1 text-sm">currency_rupee</span>
          Transaction: {{ transactionMinAmount || "0" }} -
          {{ transactionMaxAmount || "∞" }} ₹
          <button
            (click)="clearTransactionFilter()"
            class="ml-2 hover:text-[var(--color-danger)] transition-colors"
          >
            <span class="material-icons text-sm">close</span>
          </button>
        </div>

        <span
          *ngIf="activeFilters > 0"
          class="text-[var(--color-primary)] font-medium"
        >
          {{ activeFilters }} active filter(s)
        </span>
        <span *ngIf="activeFilters === 0" class="text-[var(--color-muted)]">
          No filters applied
        </span>
      </div>

      <div class="flex gap-2">
        <button
          (click)="applyAllFilters()"
          class="inline-flex items-center px-4 py-2.5 bg-[var(--color-primary)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary-dark)] transition-colors duration-200 shadow-sm"
        >
          <span class="material-icons mr-2">filter_alt</span>
          Apply Filters
        </button>
        <button
          (click)="resetFilters()"
          class="inline-flex items-center px-4 py-2.5 bg-[var(--color-bg)] text-[var(--color-font)] rounded-lg hover:bg-[var(--color-border)] transition-colors duration-200 font-medium border border-[var(--color-border)] shadow-sm"
        >
          <span class="material-icons mr-2">refresh</span>
          Reset All
        </button>
      </div>
    </div>
  </div>

  <!-- Rest of your HTML template (UPI table, modals, etc.) remains the same -->

  <!-- Table Section -->
  <div
    class="overflow-x-auto bg-[var(--color-surface)] rounded-lg border border-[var(--color-border)]"
  >
    <table class="min-w-full divide-y divide-[var(--color-border)]">
      <thead class="bg-[var(--color-bg)]">
        <tr>
          <th
            class="px-4 py-3 text-left text-xs font-semibold text-[var(--color-font)] uppercase tracking-wider"
          >
            #
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-semibold text-[var(--color-font)] uppercase tracking-wider"
          >
            Website
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-semibold text-[var(--color-font)] uppercase tracking-wider"
          >
            UPI ID
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-semibold text-[var(--color-font)] uppercase tracking-wider"
          >
            Limit
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-semibold text-[var(--color-font)] uppercase tracking-wider"
          >
            Min
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-semibold text-[var(--color-font)] uppercase tracking-wider"
          >
            Max
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-semibold text-[var(--color-font)] uppercase tracking-wider"
          >
            QR
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-semibold text-[var(--color-font)] uppercase tracking-wider"
          >
            Status
          </th>
          <th
            class="px-4 py-3 text-left text-xs font-semibold text-[var(--color-font)] uppercase tracking-wider"
          >
            Actions
          </th>
        </tr>
      </thead>
      <tbody
        class="bg-[var(--color-surface)] divide-y divide-[var(--color-border)]"
      >
        <tr
          *ngFor="let upi of pagedUpis(); let i = index"
          class="hover:bg-[var(--color-hover)] transition-colors duration-150"
        >
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="flex items-center">
              <div
                class="w-7 h-7 bg-[var(--color-bg)] rounded flex items-center justify-center"
              >
                <span class="text-sm font-semibold text-[var(--color-font)]">{{
                  (currentPage - 1) * pageSize + i + 1
                }}</span>
              </div>
            </div>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="flex items-center">
              <span class="material-icons mr-2 text-[var(--color-primary)]">
                language
              </span>
              <span class="text-sm text-[var(--color-font)]">{{
                upi.websiteDomain || "-"
              }}</span>
            </div>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="flex items-center">
              <span class="material-icons mr-2 text-[var(--color-muted)]">
                credit_card
              </span>
              <span
                class="text-sm text-[var(--color-font)] font-mono bg-[var(--color-bg)] px-2 py-1 rounded border border-[var(--color-border)]"
                >{{ upi.vpa || "-" }}</span
              >
            </div>
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <span class="text-sm text-[var(--color-font)] font-semibold"
              >₹{{ upi.limitAmount || "0" }}</span
            >
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <span class="text-sm text-[var(--color-font)] font-semibold"
              >₹{{ upi.minAmount || "0" }}</span
            >
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <span class="text-sm text-[var(--color-font)] font-semibold"
              >₹{{ upi.maxAmount || "0" }}</span
            >
          </td>
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="flex items-center">
              <div
                *ngIf="upi.qrImagePath"
                class="relative cursor-pointer"
                (click)="openImageModal(upi.qrImagePath)"
              >
                <div
                  class="w-12 h-12 bg-[var(--color-bg)] rounded border border-[var(--color-border)] flex items-center justify-center overflow-hidden"
                >
                  <img
                    [src]="upi.qrImagePath"
                    alt="QR Code"
                    class="w-10 h-10 object-contain"
                  />
                </div>
              </div>
              <div
                *ngIf="!upi.qrImagePath"
                class="flex items-center text-[var(--color-muted)] text-sm"
              >
                <span class="material-icons mr-1"> image_not_supported </span>
                No QR
              </div>
            </div>
          </td>
          <!-- Status Column -->
          <td class="px-4 py-3 whitespace-nowrap">
            <div class="flex items-center">
              <div
                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                [class.bg-green-100]="upi.status === 'active'"
                [class.text-green-800]="upi.status === 'active'"
                [class.bg-red-100]="upi.status === 'inactive'"
                [class.text-red-800]="upi.status === 'inactive'"
              >
                <span class="material-icons text-xs mr-1">
                  {{ upi.status === "active" ? "check_circle" : "cancel" }}
                </span>
                {{ upi.status === "active" ? "Active" : "Inactive" }}
              </div>
            </div>
          </td>
          <!-- Actions Column - CORRECTED VERSION -->
          <!-- Actions Column - DROPDOWN VERSION -->
          <td class="px-4 py-3 whitespace-nowrap">
            <!-- Actions Dropdown -->
            <div class="relative">
              <!-- Three dots button -->
              <button
                (click)="toggleActionsDropdown(upi.id)"
                class="p-2 text-[var(--color-muted)] hover:text-[var(--color-primary)] hover:bg-[var(--color-hover)] rounded-lg transition-colors"
                title="Actions"
              >
                <span class="material-icons">more_vert</span>
              </button>

              <!-- Dropdown menu -->
              <div
                *ngIf="activeDropdownUpiId === upi.id"
                class="absolute right-0 mt-2 w-48 bg-[var(--color-surface)] border border-[var(--color-border)] rounded-lg shadow-lg z-50"
              >
                <!-- Toggle Status -->
                <button
                  (click)="toggleUpiStatus(upi); activeDropdownUpiId = null"
                  class="w-full px-4 py-3 text-left text-sm text-[var(--color-font)] hover:bg-[var(--color-hover)] flex items-center gap-3 border-b border-[var(--color-border)]"
                >
                  <span class="material-icons">toggle_on</span>
                  <span>Toggle Status</span>
                </button>

                <!-- Edit Model -->
                <button
                  (click)="openUpdateModal(upi); activeDropdownUpiId = null"
                  class="w-full px-4 py-3 text-left text-sm text-[var(--color-font)] hover:bg-[var(--color-hover)] flex items-center gap-3"
                >
                  <span class="material-icons">edit</span>
                  <span>Edit Model</span>
                </button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div *ngIf="filteredUpis.length === 0" class="text-center py-12">
      <div class="flex flex-col items-center justify-center">
        <div
          class="w-16 h-16 bg-[var(--color-bg)] rounded-full flex items-center justify-center mb-4 border border-[var(--color-border)]"
        >
          <span class="material-icons text-[var(--color-muted)] text-3xl">
            search_off
          </span>
        </div>
        <h3 class="text-lg font-semibold text-[var(--color-font)] mb-2">
          No UPIs found
        </h3>
        <p class="text-[var(--color-muted)] max-w-md mb-6 text-sm">
          {{
            searchTerm || filterStatus
              ? "Try adjusting your search or filters"
              : "Get started by adding your first UPI"
          }}
        </p>
        <div class="flex gap-3">
          <button
            *ngIf="!searchTerm && !filterStatus"
            (click)="openAddModal()"
            class="inline-flex items-center px-4 py-2 bg-[var(--color-primary)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary-dark)] transition-colors duration-200"
          >
            <span class="material-icons mr-2">add</span>
            Add Your First UPI
          </button>
          <button
            *ngIf="searchTerm || filterStatus"
            (click)="resetFilters()"
            class="inline-flex items-center px-4 py-2 bg-[var(--color-bg)] text-[var(--color-font)] rounded-lg hover:bg-[var(--color-border)] transition-colors duration-200 font-medium border border-[var(--color-border)]"
          >
            <span class="material-icons mr-2">refresh</span>
            Clear Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div
      *ngIf="filteredUpis.length > 0"
      class="px-4 py-3 border-t border-[var(--color-border)] bg-[var(--color-bg)]"
    >
      <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
        <div class="text-sm text-[var(--color-muted)]">
          Showing {{ (currentPage - 1) * pageSize + 1 }} to
          {{ Math.min(currentPage * pageSize, filteredUpis.length) }} of
          {{ filteredUpis.length }} entries
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <span class="text-sm text-[var(--color-muted)]"
              >Rows per page:</span
            >
            <select
              [(ngModel)]="pageSize"
              (change)="onPageSizeChange()"
              class="text-sm border border-[var(--color-border)] rounded px-2 py-1 bg-[var(--color-surface)] focus:ring-1 focus:ring-[var(--color-primary)]"
            >
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="20">20</option>
            </select>
          </div>

          <div class="flex items-center gap-1">
            <button
              (click)="prevPage()"
              [disabled]="currentPage === 1"
              class="p-2 rounded border border-[var(--color-border)] hover:bg-[var(--color-surface)] disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              <span class="material-icons text-[var(--color-font)]">
                chevron_left
              </span>
            </button>

            <div class="flex items-center gap-1">
              <button
                *ngFor="let page of getPageNumbers()"
                (click)="goToPage(page)"
                [class.bg-[var(--color-primary)]!]="currentPage === page"
                [class.text-white!]="currentPage === page"
                [class.bg-[var(--color-surface)]!]="currentPage !== page"
                [class.text-[var(--color-font)]!]="currentPage !== page"
                class="w-8 h-8 rounded border border-[var(--color-border)] flex items-center justify-center text-sm font-medium hover:bg-[var(--color-hover)] transition-colors"
              >
                {{ page }}
              </button>
            </div>

            <button
              (click)="nextPage()"
              [disabled]="currentPage >= totalPages()"
              class="p-2 rounded border border-[var(--color-border)] hover:bg-[var(--color-surface)] disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              <span class="material-icons text-[var(--color-font)]">
                chevron_right
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add UPI Modal -->
  <div
    *ngIf="showAddModal"
    class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    (click)="closeAddModal()"
  >
    <div
      class="bg-[var(--color-surface)] rounded-xl max-w-md w-full max-h-[90vh] overflow-hidden shadow-lg border border-[var(--color-border)]"
      (click)="$event.stopPropagation()"
    >
      <!-- Modal Header -->
      <div
        class="flex items-center justify-between p-4 border-b border-[var(--color-border)] bg-[var(--color-bg)]"
      >
        <h3
          class="text-lg font-semibold text-[var(--color-font)] flex items-center"
        >
          <span class="material-icons mr-2 text-[var(--color-primary)]">
            add_circle
          </span>
          Add New UPI
        </h3>
        <button
          (click)="closeAddModal()"
          class="p-1 hover:bg-[var(--color-hover)] rounded transition-colors"
        >
          <span class="material-icons text-[var(--color-muted)]"> close </span>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="p-4 overflow-y-auto max-h-[calc(90vh-120px)]">
        <form
          [formGroup]="addUpiForm"
          (ngSubmit)="submitAddUpi()"
          class="space-y-4"
        >
          <!-- Website Selection -->
          <div>
            <label
              class="block text-sm font-medium text-[var(--color-font)] mb-1"
            >
              Website <span class="text-[var(--color-danger)]">*</span>
            </label>
            <select
              formControlName="websiteId"
              class="w-full px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] bg-[var(--color-surface)]"
              [class.border-[var(--color-danger)]]="
                addUpiForm.get('websiteId')?.touched &&
                addUpiForm.get('websiteId')?.invalid
              "
            >
              <option value="" disabled>Select Website</option>
              <option *ngFor="let site of websites" [value]="site.id">
                {{ site.domain }} ({{ site.currency }})
              </option>
            </select>
            <div
              *ngIf="
                addUpiForm.get('websiteId')?.touched &&
                addUpiForm.get('websiteId')?.invalid
              "
              class="text-xs text-[var(--color-danger)] mt-1 flex items-center"
            >
              <span class="material-icons mr-1 text-sm">error</span>
              Please select a website
            </div>
          </div>

          <!-- UPI ID -->
          <div>
            <label
              class="block text-sm font-medium text-[var(--color-font)] mb-1"
            >
              UPI ID (VPA) <span class="text-[var(--color-danger)]">*</span>
            </label>
            <div class="flex gap-2">
              <input
                formControlName="vpa"
                type="text"
                placeholder="username@paytm"
                class="flex-1 px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
                [class.border-[var(--color-danger)]]="
                  addUpiForm.get('vpa')?.touched &&
                  addUpiForm.get('vpa')?.invalid
                "
              />
              <button
                type="button"
                (click)="generateQrFromVpa()"
                [disabled]="addUpiForm.get('vpa')?.invalid || generatingQr"
                class="px-3 py-2 bg-[var(--color-primary)] text-white rounded-lg hover:bg-[var(--color-primary-dark)] disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span *ngIf="!generatingQr" class="flex items-center">
                  <span class="material-icons mr-1">qr_code</span>
                  QR
                </span>
                <span *ngIf="generatingQr" class="flex items-center">
                  <span class="material-icons animate-spin mr-1"
                    >autorenew</span
                  >
                </span>
              </button>
            </div>
            <div
              *ngIf="
                addUpiForm.get('vpa')?.touched && addUpiForm.get('vpa')?.invalid
              "
              class="text-xs text-[var(--color-danger)] mt-1 flex items-center"
            >
              <span class="material-icons mr-1 text-sm">error</span>
              Valid UPI ID required
            </div>
          </div>

          <!-- QR Display -->
          <div
            *ngIf="qrData"
            class="border border-[var(--color-border)] rounded-lg p-3 bg-[var(--color-bg)]"
          >
            <div class="flex justify-between items-center mb-2">
              <label class="text-sm font-medium text-[var(--color-font)]">
                Generated QR Code
              </label>
              <div class="flex gap-1">
                <button
                  type="button"
                  (click)="downloadQr()"
                  class="px-2 py-1 text-xs bg-[var(--color-primary)] text-white rounded hover:bg-[var(--color-primary-dark)] flex items-center"
                >
                  <span class="material-icons mr-1 text-sm">download</span>
                  Save
                </button>
                <button
                  type="button"
                  (click)="removeGeneratedQr()"
                  class="px-2 py-1 text-xs bg-[var(--color-surface)] text-[var(--color-font)] border border-[var(--color-border)] rounded hover:bg-[var(--color-hover)]"
                >
                  Remove
                </button>
              </div>
            </div>
            <div class="flex justify-center">
              <div
                class="p-2 bg-white rounded border border-[var(--color-border)]"
              >
                <qrcode
                  #qrcodeElem
                  [qrdata]="qrData"
                  [width]="120"
                  [errorCorrectionLevel]="'H'"
                  [margin]="1"
                  [colorDark]="'#000000'"
                  [colorLight]="'#ffffff'"
                ></qrcode>
              </div>
            </div>
          </div>

          <!-- Amount Fields -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label
                class="block text-sm font-medium text-[var(--color-font)] mb-1"
              >
                Limit Amount (₹)
                <span class="text-[var(--color-danger)]">*</span>
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--color-muted)]"
                  >₹</span
                >
                <input
                  formControlName="limitAmount"
                  type="number"
                  min="1"
                  step="1"
                  class="pl-8 w-full px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
                  placeholder="Limit"
                />
              </div>
            </div>

            <div>
              <label
                class="block text-sm font-medium text-[var(--color-font)] mb-1"
              >
                Min Amount (₹) <span class="text-[var(--color-danger)]">*</span>
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--color-muted)]"
                  >₹</span
                >
                <input
                  formControlName="minAmount"
                  type="number"
                  min="1"
                  step="1"
                  class="pl-8 w-full px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
                  placeholder="Min"
                />
              </div>
            </div>

            <div>
              <label
                class="block text-sm font-medium text-[var(--color-font)] mb-1"
              >
                Max Amount (₹) <span class="text-[var(--color-danger)]">*</span>
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--color-muted)]"
                  >₹</span
                >
                <input
                  formControlName="maxAmount"
                  type="number"
                  min="1"
                  step="1"
                  class="pl-8 w-full px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
                  placeholder="Max"
                />
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="pt-3 border-t border-[var(--color-border)]">
            <div class="flex gap-3">
              <button
                type="submit"
                [disabled]="isAddingUpi || addUpiForm.invalid || !generatedFile"
                class="flex-1 inline-flex items-center justify-center px-4 py-2.5 bg-[var(--color-primary)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary-dark)] disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span
                  *ngIf="isAddingUpi"
                  class="material-icons animate-spin mr-2"
                >
                  autorenew
                </span>
                <span *ngIf="!isAddingUpi" class="material-icons mr-2">
                  add_circle
                </span>
                {{ isAddingUpi ? "Adding..." : "Add UPI" }}
              </button>
              <button
                type="button"
                (click)="closeAddModal()"
                [disabled]="isAddingUpi"
                class="flex-1 inline-flex items-center justify-center px-4 py-2.5 bg-[var(--color-bg)] text-[var(--color-font)] rounded-lg hover:bg-[var(--color-border)] disabled:opacity-50 border border-[var(--color-border)]"
              >
                <span class="material-icons mr-2">cancel</span>
                Cancel
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Update UPI Modal -->
  <div
    *ngIf="showUpdateModal"
    class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    (click)="closeUpdateModal()"
  >
    <div
      class="bg-[var(--color-surface)] rounded-xl max-w-md w-full max-h-[90vh] overflow-hidden shadow-lg border border-[var(--color-border)]"
      (click)="$event.stopPropagation()"
    >
      <!-- Modal Header -->
      <div
        class="flex items-center justify-between p-4 border-b border-[var(--color-border)] bg-[var(--color-bg)]"
      >
        <h3
          class="text-lg font-semibold text-[var(--color-font)] flex items-center"
        >
          <span class="material-icons mr-2 text-[var(--color-primary)]">
            edit
          </span>
          Edit UPI Details
        </h3>
        <button
          (click)="closeUpdateModal()"
          class="p-1 hover:bg-[var(--color-hover)] rounded transition-colors"
        >
          <span class="material-icons text-[var(--color-muted)]"> close </span>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="p-4 overflow-y-auto max-h-[calc(90vh-120px)]">
        <form (ngSubmit)="submitUpdate()" class="space-y-4">
          <!-- Current QR Display -->
          <div
            *ngIf="editingUpi?.qrImagePath"
            class="border border-[var(--color-border)] rounded-lg p-3 bg-[var(--color-bg)]"
          >
            <label
              class="block text-sm font-medium text-[var(--color-font)] mb-2"
            >
              Current QR Code
            </label>
            <div class="flex items-center justify-between">
              <div
                class="w-20 h-20 bg-white rounded border border-[var(--color-border)] flex items-center justify-center overflow-hidden"
              >
                <img
                  [src]="editingUpi.qrImagePath"
                  alt="Current QR"
                  class="w-16 h-16 object-contain"
                />
              </div>
              <button
                type="button"
                (click)="generateQrForUpdate()"
                [disabled]="!updateForm.vpa || isGeneratingUpdateQr"
                class="px-3 py-2 bg-[var(--color-primary)] text-white rounded-lg hover:bg-[var(--color-primary-dark)] disabled:opacity-50"
              >
                <span *ngIf="!isGeneratingUpdateQr" class="flex items-center">
                  <span class="material-icons mr-1">qr_code</span>
                  New QR
                </span>
                <span *ngIf="isGeneratingUpdateQr" class="flex items-center">
                  <span class="material-icons animate-spin">autorenew</span>
                </span>
              </button>
            </div>
          </div>

          <!-- UPI ID -->
          <div>
            <label
              class="block text-sm font-medium text-[var(--color-font)] mb-1"
            >
              UPI ID (VPA) <span class="text-[var(--color-danger)]">*</span>
            </label>
            <input
              type="text"
              [(ngModel)]="updateForm.vpa"
              name="vpa"
              required
              class="w-full px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)]"
              placeholder="username@paytm"
            />
          </div>

          <!-- Amount Fields -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label
                class="block text-sm font-medium text-[var(--color-font)] mb-1"
              >
                Limit Amount (₹)
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--color-muted)]"
                  >₹</span
                >
                <input
                  type="number"
                  [(ngModel)]="updateForm.limitAmount"
                  name="limitAmount"
                  min="1"
                  step="1"
                  class="pl-8 w-full px-3 py-2 border border-[var(--color-border)] rounded-lg"
                  placeholder="Limit"
                />
              </div>
            </div>

            <div>
              <label
                class="block text-sm font-medium text-[var(--color-font)] mb-1"
              >
                Min Amount (₹)
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--color-muted)]"
                  >₹</span
                >
                <input
                  type="number"
                  [(ngModel)]="updateForm.minAmount"
                  name="minAmount"
                  min="1"
                  step="1"
                  class="pl-8 w-full px-3 py-2 border border-[var(--color-border)] rounded-lg"
                  placeholder="Min"
                />
              </div>
            </div>

            <div>
              <label
                class="block text-sm font-medium text-[var(--color-font)] mb-1"
              >
                Max Amount (₹)
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--color-muted)]"
                  >₹</span
                >
                <input
                  type="number"
                  [(ngModel)]="updateForm.maxAmount"
                  name="maxAmount"
                  min="1"
                  step="1"
                  class="pl-8 w-full px-3 py-2 border border-[var(--color-border)] rounded-lg"
                  placeholder="Max"
                />
              </div>
            </div>
          </div>

          <!-- Status -->
          <div>
            <label
              class="block text-sm font-medium text-[var(--color-font)] mb-1"
            >
              Status
            </label>
            <select
              [(ngModel)]="updateForm.status"
              name="status"
              class="w-full px-3 py-2 border border-[var(--color-border)] rounded-lg focus:ring-1 focus:ring-[var(--color-primary)] focus:border-[var(--color-primary)] bg-[var(--color-surface)] font-medium text-[var(--color-font)]"
            >
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>

          <!-- Action Buttons -->
          <div class="pt-3 border-t border-[var(--color-border)]">
            <div class="flex gap-3">
              <button
                type="submit"
                [disabled]="isSubmitting"
                class="flex-1 inline-flex items-center justify-center px-4 py-2.5 bg-[var(--color-primary)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary-dark)] disabled:opacity-50"
              >
                <span
                  *ngIf="isSubmitting"
                  class="material-icons animate-spin mr-2"
                >
                  autorenew
                </span>
                <span *ngIf="!isSubmitting" class="material-icons mr-2">
                  save
                </span>
                {{ isSubmitting ? "Saving..." : "Save Changes" }}
              </button>
              <button
                type="button"
                (click)="closeUpdateModal()"
                [disabled]="isSubmitting"
                class="flex-1 inline-flex items-center justify-center px-4 py-2.5 bg-[var(--color-bg)] text-[var(--color-font)] rounded-lg hover:bg-[var(--color-border)] disabled:opacity-50 border border-[var(--color-border)]"
              >
                <span class="material-icons mr-2">cancel</span>
                Cancel
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div
    *ngIf="selectedImage"
    class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    (click)="closeImageModal()"
  >
    <div
      class="bg-[var(--color-surface)] rounded-xl max-w-sm w-full shadow-lg border border-[var(--color-border)]"
      (click)="$event.stopPropagation()"
    >
      <!-- Modal Header -->
      <div
        class="flex items-center justify-between p-4 border-b border-[var(--color-border)] bg-[var(--color-bg)]"
      >
        <h3
          class="text-lg font-semibold text-[var(--color-font)] flex items-center"
        >
          <span class="material-icons mr-2 text-[var(--color-primary)]">
            qr_code_scanner
          </span>
          QR Code
        </h3>
        <button
          (click)="closeImageModal()"
          class="p-1 hover:bg-[var(--color-hover)] rounded transition-colors"
        >
          <span class="material-icons text-[var(--color-muted)]"> close </span>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="p-6 flex flex-col items-center">
        <div
          class="mb-4 p-3 bg-white rounded border border-[var(--color-border)]"
        >
          <img
            [src]="selectedImage"
            alt="QR Code"
            class="w-48 h-48 object-contain"
          />
        </div>
        <div class="flex gap-3">
          <button
            (click)="downloadImage()"
            class="inline-flex items-center px-4 py-2 bg-[var(--color-primary)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary-dark)]"
          >
            <span class="material-icons mr-2">download</span>
            Download
          </button>
          <button
            (click)="closeImageModal()"
            class="inline-flex items-center px-4 py-2 bg-[var(--color-bg)] text-[var(--color-font)] rounded-lg hover:bg-[var(--color-border)] border border-[var(--color-border)]"
          >
            <span class="material-icons mr-2">close</span>
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
