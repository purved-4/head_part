<div class="min-h-screen bg-gray-50 p-4 md:p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800">Work Time Report</h1>
      <p class="text-gray-600 mt-2">View detailed work time history by entity type and ID</p>
    </div>

    <!-- Form Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-gray-800">Filter Report</h2>
        <button
          (click)="clearForm()"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
        >
          Clear All
        </button>
      </div>

      <form [formGroup]="reportForm" (ngSubmit)="fetchReport()" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Entity Type -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Entity Type <span class="text-red-500">*</span>
            </label>
            <select
              formControlName="entityType"
              (change)="onRoleChange(reportForm.get('entityType')?.value)"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              [class.border-red-300]="reportForm.get('entityType')?.invalid && reportForm.get('entityType')?.touched"
            >
              <option value="" disabled>Select Entity Type</option>
              <option *ngFor="let type of entityTypes" [value]="type.id">
                {{ type.name }}
              </option>
            </select>
            <div *ngIf="reportForm.get('entityType')?.invalid && reportForm.get('entityType')?.touched" class="mt-1 text-sm text-red-600">
              Entity type is required
            </div>
          </div>

          <!-- Entity ID -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Entity ID <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <select
                formControlName="entityId"
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                [class.border-red-300]="reportForm.get('entityId')?.invalid && reportForm.get('entityId')?.touched"
                [disabled]="loadingEntities || entities.length === 0"
              >
                <option value="" disabled>Select Entity</option>
                <option *ngFor="let entity of entities" [value]="entity">
                  {{ entity.id || entity }}
                </option>
              </select>
              <div *ngIf="loadingEntities" class="absolute right-3 top-2.5">
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
              </div>
            </div>
            <div *ngIf="reportForm.get('entityId')?.invalid && reportForm.get('entityId')?.touched" class="mt-1 text-sm text-red-600">
              Entity ID is required
            </div>
            <div *ngIf="!loadingEntities && entities.length === 0 && reportForm.get('entityType')?.value" class="mt-1 text-sm text-yellow-600">
              No entities found for this role
            </div>
          </div>

          <!-- From Date -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
            <input
              type="date"
              formControlName="fromDate"
              [max]="maxDate"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
            />
          </div>

          <!-- To Date -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
            <input
              type="date"
              formControlName="toDate"
              [max]="maxDate"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
            />
          </div>
        </div>

        <!-- Date Range Validation -->
        <div *ngIf="reportForm.hasError('dateRange')" class="p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-600">
            <span class="font-medium">Invalid date range:</span> To Date cannot be earlier than From Date
          </p>
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button
            type="submit"
            [disabled]="reportForm.invalid || loading || loadingEntities"
            class="px-8 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
          >
            <span *ngIf="loading">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
            {{ loading ? 'Fetching Report...' : 'Generate Report' }}
          </button>
        </div>
      </form>
    </div>

    <!-- Report Section -->
    <div *ngIf="userGroups.length > 0" class="bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Report Header -->
      <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
          <div>
            <h3 class="text-lg font-semibold text-gray-800">Work Time Report</h3>
            <p class="text-sm text-gray-600 mt-1">
              Showing {{ totalRecords }} record(s) across {{ userGroups.length }} user(s)
            </p>
          </div>
          <div class="mt-4 md:mt-0 flex space-x-3">
            <button
              (click)="downloadPDF()"
              class="px-4 py-2 text-sm font-medium text-red-700 bg-red-50 rounded-lg hover:bg-red-100 transition-colors flex items-center"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
              </svg>
              Export PDF
            </button>
            <button
              (click)="exportToExcel()"
              class="px-4 py-2 text-sm font-medium text-green-700 bg-green-50 rounded-lg hover:bg-green-100 transition-colors flex items-center"
            >
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Export Excel
            </button>
          </div>
        </div>
      </div>

      <!-- User Groups -->
      <div class="divide-y divide-gray-200">
        <div *ngFor="let user of userGroups; let userIndex = index" class="user-group">
          <!-- User Header -->
          <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="font-semibold text-blue-800">
                  {{ user.userName || 'Unknown User' }}
                  <span class="text-blue-600 text-sm font-normal ml-2">(ID: {{ user.userId }})</span>
                </h4>
                <div class="mt-1 flex flex-wrap gap-2 text-xs">
                  <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full">
                    {{ user.records.length }} records
                  </span>
                  <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full">
                    Total Worked: {{ calculateTotalWorkedTime(user.records) }}
                  </span>
                </div>
              </div>
              <button
                (click)="toggleUserGroup(userIndex)"
                class="text-blue-600 hover:text-blue-800 transition-colors"
              >
                <svg [class.rotate-180]="!user.expanded" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
            </div>
          </div>

          <!-- User Records Table (Collapsible) -->
          <div *ngIf="user.expanded" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Date
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Clock In
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Clock Out
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Worked Time
                  </th>
                  
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let record of user.records; let recordIndex = index"
                    [class.bg-blue-50]="recordIndex % 2 === 0">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    {{ formatDate(record.date) }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {{ formatTime(record.clockIn) }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {{ formatTime(record.clockOut) }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 text-sm font-semibold bg-green-100 text-green-800 rounded-full">
                      {{ record.workedTime || calculateWorkedTime(record.clockIn, record.clockOut) }}
                    </span>
                  </td>

                </tr>
              </tbody>
              <!-- Summary Row -->
              <tfoot class="bg-gray-50">
                <tr>
                  <td colspan="1" class="px-6 py-3 text-sm text-gray-500">
                    Average per day: {{ calculateAverageWorkedTime(user.records) }}
                  </td>
                  <td colspan="2" class="px-6 py-3 text-sm font-medium text-gray-900 text-right">
                    {{ user.userName || 'Unknown User' }} Total:
                  </td>
                  <td class="px-6 py-3 text-sm font-bold text-gray-900">
                    {{ calculateTotalWorkedTime(user.records) }}
                  </td>
                  
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

     
      <!-- Empty State -->
      <div *ngIf="userGroups.length === 0 && !loading" class="text-center py-12">
        <div class="mx-auto w-24 h-24 text-gray-400 mb-4">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No Data Found</h3>
        <p class="text-gray-500">Try adjusting your filters to find what you're looking for.</p>
      </div>
    </div>
  </div>
</div>