<div
  [ngClass]="{
    'bg-gradient-to-br from-orange-50 to-orange-25':
      role?.toLowerCase() === 'head',
    'bg-gradient-to-br from-yellow-50 to-yellow-25':
      role?.toLowerCase() === 'branch',
  }"
  class="min-h-screen p-4 md:p-8 transition-all duration-300"
  [ngStyle]="{ background: 'var(--color-bg)' }"
>
  <!-- Main Container -->
  <div class="max-w-7xl mx-auto">
    <!-- Glassmorphism Card Container -->
    <div
      class="rounded-2xl border shadow-soft overflow-hidden"
      style="
        background-color: var(--color-surface);
        border-color: var(--color-border);
        backdrop-filter: blur(8px);
      "
    >
      <!-- Header -->
      <div
        class="px-8 py-6 border-b"
        style="
          border-color: var(--color-border);
          background: linear-gradient(
            to right,
            var(--color-surface),
            var(--color-surface) / 30%
          );
        "
      >
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold mb-1 text-[var(--color-font)]">
              Capacity Management
            </h1>
            <p class="text-sm font-medium text-[var(--color-muted)]">
              Configure transaction capacities for websites
            </p>
          </div>
          <!-- Role Badge -->
          <div
            class="px-4 py-2 rounded-full text-sm font-semibold border shadow-sm"
            style="
              background: var(--color-surface);
              color: var(--color-font);
              border-color: var(--color-border);
            "
          >
            {{ role?.toUpperCase() || "ADMIN" }}
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="p-8">
        <!-- Messages -->
        <div
          *ngIf="successMessage"
          class="mb-6 p-4 rounded-lg border flex items-center justify-between bg-[var(--color-success)/10%] border-[var(--color-success)]"
        >
          <div class="flex items-center">
            <span class="material-icons text-[var(--color-success)] mr-2"
              >check_circle</span
            >
            <span class="text-sm text-[var(--color-success)]">{{
              successMessage
            }}</span>
          </div>
          <button
            (click)="successMessage = ''"
            class="text-[var(--color-success)]"
          >
            <span class="material-icons">close</span>
          </button>
        </div>

        <div
          *ngIf="errorMessage"
          class="mb-6 p-4 rounded-lg border flex items-center justify-between bg-[var(--color-danger)/10%] border-[var(--color-danger)]"
        >
          <div class="flex items-center">
            <span class="material-icons text-[var(--color-danger)] mr-2"
              >error</span
            >
            <span class="text-sm text-[var(--color-danger)]">{{
              errorMessage
            }}</span>
          </div>
          <button
            (click)="errorMessage = ''"
            class="text-[var(--color-danger)]"
          >
            <span class="material-icons">close</span>
          </button>
        </div>

        <!-- Loading State -->
        <div
          *ngIf="isLoading"
          class="py-16 text-center bg-[var(--color-surface)] rounded-xl border border-[var(--color-border)]"
        >
          <div class="flex flex-col items-center">
            <span
              class="material-icons animate-spin text-[var(--color-primary)] text-4xl mb-3"
              >refresh</span
            >
            <p class="text-sm text-[var(--color-muted)]">
              Loading configuration...
            </p>
          </div>
        </div>

        <!-- Main Form -->
        <form
          [formGroup]="capacityForm"
          (ngSubmit)="onSubmit()"
          *ngIf="!isLoading"
        >
          <!-- 4-COLUMN LAYOUT -->
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- ========== COLUMN 1: Transaction Settings + Website Search (3 cols) ========== -->
            <div class="lg:col-span-3 space-y-6">
              <!-- Transaction Settings Card -->
              <div
                class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-border)] p-5 shadow-sm"
              >
                <h3
                  class="text-sm font-semibold text-[var(--color-font)] mb-4 flex items-center"
                >
                  <span
                    class="w-1.5 h-1.5 rounded-full bg-[var(--color-primary)] mr-2"
                  ></span>
                  Transaction Settings
                </h3>

                <!-- Transaction Type -->
                <div class="mb-5">
                  <div class="flex items-center justify-between mb-3">
                    <label class="text-xs font-medium text-[var(--color-font)]"
                      >Transaction Type *</label
                    >
                    <span
                      class="text-[10px] px-2 py-1 rounded-full bg-[var(--color-surface)] text-[var(--color-muted)] border border-[var(--color-border)]"
                      >Required</span
                    >
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <button
                      type="button"
                      *ngFor="let type of transactionTypes"
                      (click)="
                        capacityForm.get('type')?.setValue(type.value);
                        onTypeChange()
                      "
                      class="py-2.5 px-3 rounded-lg text-xs font-medium transition-all border"
                      [ngClass]="{
                        'bg-[var(--color-primary)]/10 border-[var(--color-primary)] text-[var(--color-primary)]':
                          capacityForm.get('type')?.value === type.value,
                        'bg-[var(--color-surface)] border-[var(--color-border)] text-[var(--color-font)] hover:bg-[var(--color-hover)]':
                          capacityForm.get('type')?.value !== type.value,
                      }"
                    >
                      {{ type.label }}
                    </button>
                  </div>
                </div>

                <!-- Transaction Mode -->
                <div>
                  <div class="flex items-center justify-between mb-3">
                    <label class="text-xs font-medium text-[var(--color-font)]">
                      Transaction Mode
                      <span
                        *ngIf="capacityForm.get('type')?.value === 'TOPUP'"
                        class="text-[var(--color-danger)]"
                        >*</span
                      >
                    </label>
                    <span
                      *ngIf="capacityForm.get('type')?.value === 'TOPUP'"
                      class="text-[10px] px-2 py-1 rounded-full bg-[var(--color-surface)] text-[var(--color-muted)] border border-[var(--color-border)]"
                      >Required</span
                    >
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                    <button
                      type="button"
                      *ngFor="let mode of transactionModes"
                      (click)="capacityForm.get('mode')?.setValue(mode.value)"
                      [disabled]="capacityForm.get('type')?.value === 'PAYOUT'"
                      class="py-2.5 px-3 rounded-lg text-xs font-medium transition-all border disabled:opacity-50 disabled:cursor-not-allowed"
                      [ngClass]="{
                        'bg-[var(--color-primary)]/10 border-[var(--color-primary)] text-[var(--color-primary)]':
                          capacityForm.get('mode')?.value === mode.value &&
                          capacityForm.get('type')?.value === 'TOPUP',
                        'bg-[var(--color-surface)] border-[var(--color-border)] text-[var(--color-font)] hover:bg-[var(--color-hover)]':
                          capacityForm.get('mode')?.value !== mode.value ||
                          capacityForm.get('type')?.value !== 'TOPUP',
                      }"
                    >
                      {{ mode.label }}
                    </button>
                  </div>
                  <p
                    *ngIf="capacityForm.get('type')?.value === 'PAYOUT'"
                    class="text-xs text-[var(--color-muted)] mt-3 p-2 bg-[var(--color-surface)]/50 rounded-lg border border-[var(--color-border)]"
                  >
                    Mode not required for Payout
                  </p>
                </div>
              </div>

              <!-- Website Selection Card - SEARCH BASED -->
              <div
                class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-border)] p-5 shadow-sm"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-sm font-semibold text-[var(--color-font)] flex items-center"
                  >
                    <span
                      class="w-1.5 h-1.5 rounded-full bg-[var(--color-success)] mr-2"
                    ></span>
                    Website Selection
                  </h3>
                  <span
                    class="text-[10px] px-2 py-1 rounded-full bg-[var(--color-surface)] text-[var(--color-muted)] border border-[var(--color-border)]"
                  >
                    Required
                  </span>
                </div>

                <!-- SEARCH BASED INPUT -->
                <div class="relative">
                  <div
                    class="flex items-center border rounded-lg bg-[var(--color-surface)] transition-all focus-within:ring-2 focus-within:ring-[var(--color-primary)]/20"
                    [ngClass]="{
                      'border-[var(--color-danger)]':
                        capacityForm.get('websiteId')?.invalid &&
                        capacityForm.get('websiteId')?.touched,
                      'border-[var(--color-border)]': !(
                        capacityForm.get('websiteId')?.invalid &&
                        capacityForm.get('websiteId')?.touched
                      ),
                    }"
                  >
                    <span
                      class="material-icons text-[var(--color-muted)] ml-3 text-sm"
                      >search</span
                    >
                    <input
                      type="text"
                      (input)="onWebsiteSearch($event)"
                      (focus)="showWebsiteDropdown = true"
                      [value]="selectedWebsiteDomain || ''"
                      placeholder="Search websites by domain or ID..."
                      class="w-full px-3 py-3 text-sm focus:outline-none bg-transparent text-[var(--color-font)] placeholder-[var(--color-muted)]"
                      autocomplete="off"
                    />
                    <button
                      *ngIf="selectedWebsiteDomain"
                      type="button"
                      (click)="clearWebsiteSelection()"
                      class="mr-2 text-[var(--color-muted)] hover:text-[var(--color-danger)] transition-colors"
                    >
                      <span class="material-icons text-sm">close</span>
                    </button>
                  </div>

                  <!-- SEARCH RESULTS -->
                  <div
                    *ngIf="showWebsiteDropdown && filteredWebsites.length > 0"
                    class="absolute z-50 w-full mt-1 border rounded-lg shadow-lg bg-[var(--color-surface)] border-[var(--color-border)] max-h-60 overflow-y-auto"
                  >
                    <div
                      class="p-2 border-b border-[var(--color-border)] bg-[var(--color-bg)]/50"
                    >
                      <span
                        class="text-xs font-medium text-[var(--color-muted)]"
                        >Available Websites</span
                      >
                    </div>
                    <div
                      *ngFor="let website of filteredWebsites"
                      (mousedown)="selectWebsite(website)"
                      class="px-3 py-2.5 cursor-pointer hover:bg-[var(--color-hover)] flex items-center justify-between border-b last:border-b-0 border-[var(--color-border)] transition-colors"
                    >
                      <div class="flex items-center">
                        <span
                          class="material-icons text-[var(--color-primary)] mr-2 text-sm"
                          >public</span
                        >
                        <span class="text-sm text-[var(--color-font)]">{{
                          website.websiteDomain || website.domain
                        }}</span>
                        <span class="text-xs text-[var(--color-muted)] ml-2"
                          >({{ website.currency || "INR" }})</span
                        >
                      </div>
                      <span
                        *ngIf="
                          capacityForm.get('websiteId')?.value ===
                          website.websiteId
                        "
                        class="material-icons text-[var(--color-success)] text-sm"
                        >check_circle</span
                      >
                    </div>
                  </div>

                  <!-- NO RESULTS -->
                  <div
                    *ngIf="
                      showWebsiteDropdown &&
                      filteredWebsites.length === 0 &&
                      selectedWebsiteDomain
                    "
                    class="absolute z-50 w-full mt-1 border rounded-lg shadow-lg bg-[var(--color-surface)] border-[var(--color-border)] p-4 text-center"
                  >
                    <span
                      class="material-icons text-[var(--color-muted)] text-3xl mb-1"
                      >search_off</span
                    >
                    <p class="text-sm text-[var(--color-muted)]">
                      No websites found
                    </p>
                    <p class="text-xs text-[var(--color-muted)] mt-1">
                      Try a different search term
                    </p>
                  </div>
                </div>

                <!-- SELECTED WEBSITE DISPLAY -->
                <div
                  *ngIf="selectedWebsiteDomain"
                  class="mt-3 p-2.5 bg-[var(--color-success)]/10 rounded-lg border border-[var(--color-success)] flex items-center"
                >
                  <span
                    class="material-icons text-[var(--color-success)] mr-2 text-sm"
                    >check_circle</span
                  >
                  <span class="text-xs font-medium text-[var(--color-success)]"
                    >Selected:</span
                  >
                  <span class="text-xs text-[var(--color-success)] ml-1">{{
                    selectedWebsiteDomain
                  }}</span>
                </div>

                <!-- VALIDATION -->
                <div
                  *ngIf="
                    capacityForm.get('websiteId')?.invalid &&
                    capacityForm.get('websiteId')?.touched
                  "
                  class="text-xs text-[var(--color-danger)] mt-2 flex items-center"
                >
                  <span class="material-icons mr-1 text-sm">error</span>
                  Please select a website
                </div>
              </div>

              <!-- Upto Requirement Warning -->
              <div
                *ngIf="!hasUptoRange && capacityRanges.length > 0"
                class="bg-[var(--color-warning)]/10 border border-[var(--color-warning)] rounded-lg p-3 flex items-start"
              >
                <span
                  class="material-icons text-[var(--color-warning)] mr-2 text-sm mt-0.5"
                  >warning</span
                >
                <div>
                  <p class="text-xs font-medium text-[var(--color-warning)]">
                    Important Requirement
                  </p>
                  <p class="text-xs text-[var(--color-warning)]/90 mt-0.5">
                    At least one range must be marked as "upto"
                  </p>
                </div>
              </div>
            </div>

            <!-- ========== COLUMN 2: Primary Range + Add Range Button (3 cols) ========== -->
            <div class="lg:col-span-3">
              <div
                class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-border)] p-5 shadow-sm h-full flex flex-col"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-sm font-semibold text-[var(--color-font)] flex items-center"
                  >
                    <span
                      class="w-1.5 h-1.5 rounded-full bg-[var(--color-primary)] mr-2"
                    ></span>
                    Primary Range
                  </h3>
                  <div class="flex items-center gap-2">
                    <span
                      class="text-xs text-[var(--color-muted)] bg-[var(--color-bg)]/50 px-2 py-1 rounded-full border border-[var(--color-border)]"
                    >
                      Range 1
                    </span>
                    <button
                      type="button"
                      (click)="addCapacityRange()"
                      [disabled]="hasUptoRange"
                      class="inline-flex items-center px-2.5 py-1.5 bg-[var(--color-primary)] text-[var(--color-surface)] rounded-lg text-xs font-medium hover:bg-[var(--color-primary-dark)] disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                    >
                      <span class="material-icons mr-1 text-sm">add</span>
                      Add
                    </button>
                  </div>
                </div>

                <!-- Range 1 Card -->
                <div formArrayName="capacityRanges">
                  <div
                    *ngIf="
                      capacityRanges &&
                      capacityRanges.controls &&
                      capacityRanges.controls.length > 0
                    "
                    [formGroupName]="0"
                    class="relative rounded-lg p-4 transition-all"
                    [ngClass]="{
                      'bg-[var(--color-primary)]/5 border-2 border-[var(--color-primary)]/30':
                        capacityRanges.at(0).get('upto')?.value,
                      'bg-[var(--color-surface)] border border-[var(--color-border)]':
                        !capacityRanges.at(0).get('upto')?.value,
                    }"
                  >
                    <!-- INFINITE RANGE Badge -->
                    <div
                      *ngIf="capacityRanges.at(0).get('upto')?.value"
                      class="absolute -top-2.5 right-3 px-2 py-0.5 rounded-full text-[9px] font-bold bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-primary-light)] text-[var(--color-surface)] border border-[var(--color-primary)]/50 shadow-sm"
                    >
                      INFINITE RANGE
                    </div>

                    <!-- Range Header -->
                    <div class="flex items-center justify-between mb-3">
                      <div class="flex items-center">
                        <span
                          class="w-2 h-2 rounded-full mr-2"
                          [ngClass]="{
                            'bg-[var(--color-primary)]': capacityRanges
                              .at(0)
                              .get('upto')?.value,
                            'bg-[var(--color-muted)]': !capacityRanges
                              .at(0)
                              .get('upto')?.value,
                          }"
                        ></span>
                        <span
                          class="text-sm font-medium text-[var(--color-font)]"
                          >Range 1</span
                        >
                        <span
                          *ngIf="capacityRanges.at(0).get('upto')?.value"
                          class="text-[10px] text-[var(--color-muted)] ml-2 px-1.5 py-0.5 bg-[var(--color-surface)]/80 rounded-full border border-[var(--color-border)]"
                          >Final</span
                        >
                      </div>
                    </div>

                    <!-- Upto Checkbox -->
                    <div class="mb-4">
                      <label class="flex items-center cursor-pointer">
                        <div class="relative">
                          <input
                            type="checkbox"
                            formControlName="upto"
                            (change)="onUptoChange(0)"
                            class="sr-only"
                            [disabled]="
                              hasUptoRange &&
                              !capacityRanges.at(0).get('upto')?.value
                            "
                          />
                          <div
                            class="block w-10 h-5 rounded-full transition-colors duration-200"
                            [ngClass]="{
                              'bg-[var(--color-primary)]': capacityRanges
                                .at(0)
                                .get('upto')?.value,
                              'bg-[var(--color-border)]': !capacityRanges
                                .at(0)
                                .get('upto')?.value,
                            }"
                          ></div>
                          <div
                            class="dot absolute left-0.5 top-0.5 w-4 h-4 rounded-full bg-white transition-transform duration-200 shadow-sm"
                            [ngStyle]="{
                              transform: capacityRanges.at(0).get('upto')?.value
                                ? 'translateX(20px)'
                                : 'translateX(0)',
                            }"
                          ></div>
                        </div>
                        <span
                          class="ml-2 text-xs font-medium text-[var(--color-font)]"
                          >Upto (Infinite)</span
                        >
                      </label>
                    </div>

                    <!-- Input Grid - 2x2 -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                      <!-- Min -->
                      <div>
                        <label
                          class="text-[10px] text-[var(--color-muted)] block mb-1"
                          >Min Range</label
                        >
                        <div class="relative">
                          <input
                            type="number"
                            formControlName="minRange"
                            readonly
                            class="w-full px-2 py-2 text-xs border rounded-lg bg-[var(--color-surface)]/50 text-[var(--color-muted)] border-[var(--color-border)]"
                          />
                          <span
                            class="absolute right-2 top-2 text-[10px] text-[var(--color-muted)]"
                            >₹</span
                          >
                        </div>
                      </div>
                      <!-- Max -->
                      <div>
                        <label
                          class="text-[10px] text-[var(--color-muted)] block mb-1"
                        >
                          Max Range
                          <span
                            *ngIf="!capacityRanges.at(0).get('upto')?.value"
                            class="text-[var(--color-danger)]"
                            >*</span
                          >
                        </label>
                        <div class="relative">
                          <input
                            type="number"
                            formControlName="maxRange"
                            (change)="onMaxRangeChange(0)"
                            class="w-full px-2 py-2 text-xs border rounded-lg bg-[var(--color-surface)] text-[var(--color-font)] transition-colors"
                            [ngClass]="{
                              'border-[var(--color-danger)] focus:ring-1 focus:ring-[var(--color-danger)]/30':
                                capacityRanges.at(0).get('maxRange')?.invalid &&
                                capacityRanges.at(0).get('maxRange')?.touched,
                              'border-[var(--color-border)] focus:ring-1 focus:ring-[var(--color-primary)]/30':
                                !(
                                  capacityRanges.at(0).get('maxRange')
                                    ?.invalid &&
                                  capacityRanges.at(0).get('maxRange')?.touched
                                ),
                            }"
                            placeholder="0"
                          />
                          <span
                            class="absolute right-2 top-2 text-[10px] text-[var(--color-muted)]"
                            >₹</span
                          >
                        </div>
                      </div>
                      <!-- Qty -->
                      <div>
                        <label
                          class="text-[10px] text-[var(--color-muted)] block mb-1"
                        >
                          Quantity
                          <span class="text-[var(--color-danger)]">*</span>
                        </label>
                        <input
                          type="number"
                          formControlName="quantity"
                          class="w-full px-2 py-2 text-xs border rounded-lg bg-[var(--color-surface)] text-[var(--color-font)] border-[var(--color-border)] focus:ring-1 focus:ring-[var(--color-primary)]/30 transition-colors"
                          placeholder="0"
                        />
                      </div>
                      <!-- Time -->
                      <div>
                        <label
                          class="text-[10px] text-[var(--color-muted)] block mb-1"
                        >
                          Time (min)
                          <span class="text-[var(--color-danger)]">*</span>
                        </label>
                        <input
                          type="number"
                          formControlName="time"
                          class="w-full px-2 py-2 text-xs border rounded-lg bg-[var(--color-surface)] text-[var(--color-font)] border-[var(--color-border)] focus:ring-1 focus:ring-[var(--color-primary)]/30 transition-colors"
                          placeholder="Min"
                        />
                      </div>
                    </div>

                    <!-- Validation Errors -->
                    <div
                      class="text-[10px] text-[var(--color-danger)] mb-2 space-y-0.5"
                    >
                      <div
                        *ngIf="
                          capacityRanges.at(0).get('maxRange')?.invalid &&
                          capacityRanges.at(0).get('maxRange')?.touched &&
                          !capacityRanges.at(0).get('upto')?.value
                        "
                      >
                        <span
                          *ngIf="
                            capacityRanges.at(0).get('maxRange')?.errors?.[
                              'required'
                            ]
                          "
                          >Max range is required</span
                        >
                        <span
                          *ngIf="
                            capacityRanges.at(0).get('maxRange')?.errors?.[
                              'min'
                            ]
                          "
                          >Must be greater than 0</span
                        >
                      </div>
                      <div
                        *ngIf="
                          capacityRanges.at(0).get('quantity')?.invalid &&
                          capacityRanges.at(0).get('quantity')?.touched
                        "
                      >
                        <span
                          *ngIf="
                            capacityRanges.at(0).get('quantity')?.errors?.[
                              'required'
                            ]
                          "
                          >Quantity required</span
                        >
                        <span
                          *ngIf="
                            capacityRanges.at(0).get('quantity')?.errors?.[
                              'min'
                            ]
                          "
                          >Min 1</span
                        >
                      </div>
                      <div
                        *ngIf="
                          capacityRanges.at(0).get('time')?.invalid &&
                          capacityRanges.at(0).get('time')?.touched
                        "
                      >
                        <span
                          *ngIf="
                            capacityRanges.at(0).get('time')?.errors?.[
                              'required'
                            ]
                          "
                          >Time required</span
                        >
                        <span
                          *ngIf="
                            capacityRanges.at(0).get('time')?.errors?.['min']
                          "
                          >Min 1 min</span
                        >
                      </div>
                    </div>

                    <!-- Preview -->
                    <div
                      class="pt-3 mt-1 border-t border-[var(--color-border)]"
                    >
                      <div class="flex items-center justify-between">
                        <div>
                          <span
                            class="text-[10px] text-[var(--color-muted)] block mb-1"
                            >Preview</span
                          >
                          <span
                            class="text-xs font-semibold text-[var(--color-font)]"
                          >
                            {{
                              capacityRanges.at(0).get("upto")?.value
                                ? "0 → ∞"
                                : "0 → " +
                                  (capacityRanges.at(0).get("maxRange")
                                    ?.value || "—")
                            }}
                          </span>
                        </div>
                        <div class="text-right">
                          <span
                            class="text-[10px] text-[var(--color-muted)] block mb-1"
                            >Capacity</span
                          >
                          <span
                            class="text-xs font-medium text-[var(--color-primary)]"
                          >
                            {{
                              capacityRanges.at(0).get("quantity")?.value || "0"
                            }}
                            txns
                          </span>
                          <span
                            class="text-[10px] text-[var(--color-muted)] ml-1"
                          >
                            /
                            {{ capacityRanges.at(0).get("time")?.value || "0" }}
                            min
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Add Range Disabled Message -->
                <div
                  *ngIf="hasUptoRange"
                  class="mt-4 p-2 bg-[var(--color-warning)]/10 rounded-lg border border-[var(--color-warning)]"
                >
                  <p
                    class="text-xs text-[var(--color-warning)] flex items-center"
                  >
                    <span class="material-icons mr-1 text-sm">info</span>
                    Cannot add new range after an "upto" range
                  </p>
                </div>
              </div>
            </div>

            <!-- ========== COLUMN 3: Intermediate Ranges (3 cols) ========== -->
            <div class="lg:col-span-3">
              <div
                class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-border)] p-5 shadow-sm h-full flex flex-col"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-sm font-semibold text-[var(--color-font)] flex items-center"
                  >
                    <span
                      class="w-1.5 h-1.5 rounded-full bg-[var(--color-primary)] mr-2"
                    ></span>
                    Intermediate Ranges
                  </h3>
                  <span
                    class="text-xs text-[var(--color-muted)] bg-[var(--color-bg)]/50 px-2 py-1 rounded-full border border-[var(--color-border)]"
                  >
                    {{ getIntermediateRangesCount() }} range(s)
                  </span>
                </div>

                <!-- SCROLLABLE CONTAINER for INTERMEDIATE RANGES (non-upto ranges except the last one if it's upto) -->
                <div
                  *ngIf="getIntermediateRanges().length > 0"
                  class="flex-1 overflow-y-auto pr-1 space-y-3"
                  style="
                    max-height: 500px;
                    scrollbar-width: thin;
                    scrollbar-color: var(--color-border) transparent;
                  "
                >
                  <div
                    formArrayName="capacityRanges"
                    *ngFor="let range of getIntermediateRanges(); let i = index"
                    [formGroupName]="getIntermediateRangeIndex(i)"
                    class="relative border rounded-lg p-3 bg-[var(--color-surface)] transition-all hover:shadow-md"
                    [ngClass]="{
                      'border-[var(--color-primary)]/40 bg-[var(--color-primary)]/5':
                        range.get('upto')?.value,
                      'border-[var(--color-border)] hover:border-[var(--color-primary)]/20':
                        !range.get('upto')?.value,
                    }"
                  >
                    <!-- INFINITE RANGE Badge - Compact -->
                    <div
                      *ngIf="range.get('upto')?.value"
                      class="absolute -top-2 right-2 px-1.5 py-0.5 rounded-full text-[8px] font-bold bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-primary-light)] text-[var(--color-surface)] border border-[var(--color-primary)]/50 shadow-sm"
                    >
                      INFINITE
                    </div>

                    <!-- Header with Delete -->
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center">
                        <span
                          class="w-1.5 h-1.5 rounded-full mr-1.5"
                          [ngClass]="{
                            'bg-[var(--color-primary)]':
                              range.get('upto')?.value,
                            'bg-[var(--color-muted)]':
                              !range.get('upto')?.value,
                          }"
                        ></span>
                        <span
                          class="text-xs font-medium text-[var(--color-font)]"
                          >Range {{ getIntermediateRangeIndex(i) + 1 }}</span
                        >
                        <span
                          *ngIf="range.get('upto')?.value"
                          class="text-[9px] text-[var(--color-muted)] ml-1.5 px-1 py-0.5 bg-[var(--color-surface)]/80 rounded-full border border-[var(--color-border)]"
                          >Final</span
                        >
                      </div>
                      <button
                        *ngIf="!range.get('upto')?.value"
                        type="button"
                        (click)="
                          removeCapacityRange(getIntermediateRangeIndex(i))
                        "
                        class="text-[var(--color-muted)] hover:text-[var(--color-danger)] transition-colors p-0.5 rounded-full hover:bg-[var(--color-danger)]/10"
                      >
                        <span class="material-icons text-sm"
                          >delete_outline</span
                        >
                      </button>
                    </div>

                    <!-- Upto Checkbox - Compact -->
                    <div class="mb-2">
                      <label class="flex items-center cursor-pointer">
                        <div class="relative">
                          <input
                            type="checkbox"
                            formControlName="upto"
                            (change)="
                              onUptoChange(getIntermediateRangeIndex(i))
                            "
                            class="sr-only"
                            [disabled]="
                              hasUptoRange && !range.get('upto')?.value
                            "
                          />
                          <div
                            class="block w-8 h-4 rounded-full transition-colors duration-200"
                            [ngClass]="{
                              'bg-[var(--color-primary)]':
                                range.get('upto')?.value,
                              'bg-[var(--color-border)]':
                                !range.get('upto')?.value,
                            }"
                          ></div>
                          <div
                            class="dot absolute left-0.5 top-0.5 w-3 h-3 rounded-full bg-white transition-transform duration-200 shadow-sm"
                            [ngStyle]="{
                              transform: range.get('upto')?.value
                                ? 'translateX(14px)'
                                : 'translateX(0)',
                            }"
                          ></div>
                        </div>
                        <span
                          class="ml-2 text-[10px] font-medium text-[var(--color-font)]"
                          >Upto</span
                        >
                      </label>
                    </div>

                    <!-- Compact Input Grid - 2x2 -->
                    <div class="grid grid-cols-2 gap-2 mb-2">
                      <div>
                        <div class="relative">
                          <input
                            type="number"
                            formControlName="minRange"
                            readonly
                            class="w-full px-1.5 py-1.5 text-[10px] border rounded bg-[var(--color-surface)]/50 text-[var(--color-muted)] border-[var(--color-border)]"
                          />
                          <span
                            class="absolute right-1.5 top-1.5 text-[8px] text-[var(--color-muted)]"
                            >₹</span
                          >
                        </div>
                      </div>
                      <div class="relative">
                        <input
                          type="number"
                          formControlName="maxRange"
                          (change)="
                            onMaxRangeChange(getIntermediateRangeIndex(i))
                          "
                          class="w-full px-1.5 py-1.5 text-[10px] border rounded bg-[var(--color-surface)] text-[var(--color-font)] transition-colors"
                          [ngClass]="{
                            'border-[var(--color-danger)]':
                              range.get('maxRange')?.invalid &&
                              range.get('maxRange')?.touched,
                            'border-[var(--color-border)]': !(
                              range.get('maxRange')?.invalid &&
                              range.get('maxRange')?.touched
                            ),
                          }"
                          [value]="range.get('maxRange')?.value"
                          placeholder="Max"
                        />
                        <span
                          class="absolute right-1.5 top-1.5 text-[8px] text-[var(--color-muted)]"
                          >₹</span
                        >
                      </div>
                      <div>
                        <input
                          type="number"
                          formControlName="quantity"
                          class="w-full px-1.5 py-1.5 text-[10px] border rounded bg-[var(--color-surface)] text-[var(--color-font)] border-[var(--color-border)]"
                          [value]="range.get('quantity')?.value"
                          placeholder="Qty"
                        />
                      </div>
                      <div>
                        <input
                          type="number"
                          formControlName="time"
                          class="w-full px-1.5 py-1.5 text-[10px] border rounded bg-[var(--color-surface)] text-[var(--color-font)] border-[var(--color-border)]"
                          [value]="range.get('time')?.value"
                          placeholder="Min"
                        />
                      </div>
                    </div>

                    <!-- Compact Preview -->
                    <div
                      class="pt-1.5 mt-1 border-t border-[var(--color-border)]"
                    >
                      <div class="flex items-center justify-between">
                        <div class="flex items-center">
                          <span
                            class="text-[9px] text-[var(--color-muted)] mr-1"
                            >→</span
                          >
                          <span
                            class="text-[10px] font-medium text-[var(--color-font)]"
                          >
                            {{
                              range.get("upto")?.value
                                ? "∞"
                                : range.get("maxRange")?.value || "—"
                            }}
                          </span>
                        </div>
                        <span class="text-[8px] text-[var(--color-muted)]">
                          {{ range.get("quantity")?.value || 0 }} /
                          {{ range.get("time")?.value || 0 }}min
                        </span>
                      </div>
                    </div>

                    <!-- Validation Errors - Compact -->
                    <div class="text-[8px] text-[var(--color-danger)] mt-1">
                      <div
                        *ngIf="
                          range.get('maxRange')?.invalid &&
                          range.get('maxRange')?.touched &&
                          !range.get('upto')?.value
                        "
                      >
                        <span
                          *ngIf="range.get('maxRange')?.errors?.['required']"
                          >Required</span
                        >
                        <span *ngIf="range.get('maxRange')?.errors?.['min']"
                          >Min ₹1</span
                        >
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Empty State for Intermediate Ranges -->
                <div
                  *ngIf="getIntermediateRanges().length === 0"
                  class="flex-1 flex flex-col items-center justify-center border-2 border-dashed border-[var(--color-border)] rounded-lg p-6 bg-[var(--color-surface)]/50"
                >
                  <span
                    class="material-icons text-[var(--color-muted)] text-3xl mb-2"
                    >add_circle_outline</span
                  >
                  <p class="text-sm font-medium text-[var(--color-muted)]">
                    No intermediate ranges
                  </p>
                  <p class="text-xs text-[var(--color-muted)] mt-1 text-center">
                    Click "Add" button in Primary Range to create more ranges
                  </p>
                </div>
              </div>
            </div>

            <!-- ========== COLUMN 4: Final/Infinite Range (3 cols) ========== -->
            <div class="lg:col-span-3">
              <div
                class="bg-[var(--color-surface)] rounded-xl border border-[var(--color-border)] p-5 shadow-sm h-full"
                [ngClass]="{
                  'border-2 border-[var(--color-primary)]/50 bg-[var(--color-primary)]/5':
                    getFinalRange(),
                }"
              >
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-sm font-semibold text-[var(--color-font)] flex items-center"
                  >
                    <span
                      class="w-1.5 h-1.5 rounded-full bg-[var(--color-primary)] mr-2"
                    ></span>
                    Final Range
                    <span
                      *ngIf="getFinalRange()"
                      class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-primary-light)] text-[var(--color-surface)] border border-[var(--color-primary)]/50 shadow-sm"
                    >
                      INFINITE
                    </span>
                  </h3>
                  <span
                    *ngIf="getFinalRange()"
                    class="text-xs text-[var(--color-muted)] bg-[var(--color-bg)]/50 px-2 py-1 rounded-full border border-[var(--color-border)]"
                  >
                    Range {{ getFinalRangeIndex() + 1 }}
                  </span>
                  <span
                    *ngIf="!getFinalRange()"
                    class="text-xs text-[var(--color-muted)] bg-[var(--color-bg)]/50 px-2 py-1 rounded-full border border-[var(--color-border)]"
                  >
                    Not Set
                  </span>
                </div>

                <!-- Final Range Card -->
                <div
                  *ngIf="getFinalRange()"
                  formArrayName="capacityRanges"
                  [formGroupName]="getFinalRangeIndex()"
                >
                  <div class="relative rounded-lg p-4 transition-all">
                    <!-- Range Header -->
                    <div class="flex items-center justify-between mb-3">
                      <div class="flex items-center">
                        <span
                          class="w-2 h-2 rounded-full mr-2 bg-[var(--color-primary)]"
                        ></span>
                        <span
                          class="text-sm font-medium text-[var(--color-font)]"
                          >Range {{ getFinalRangeIndex() + 1 }}</span
                        >
                        <span
                          class="text-[10px] text-[var(--color-muted)] ml-2 px-1.5 py-0.5 bg-[var(--color-surface)]/80 rounded-full border border-[var(--color-border)]"
                          >Final</span
                        >
                      </div>
                      <button
                        *ngIf="getFinalRange()"
                        type="button"
                        (click)="removeFinalRange()"
                        class="text-[var(--color-muted)] hover:text-[var(--color-danger)] transition-colors p-1 rounded-full hover:bg-[var(--color-danger)]/10"
                      >
                        <span class="material-icons text-sm"
                          >delete_outline</span
                        >
                      </button>
                    </div>

                    <!-- Upto Checkbox - Disabled and Checked -->
                    <div class="mb-4">
                      <label class="flex items-center cursor-not-allowed">
                        <div class="relative">
                          <input
                            type="checkbox"
                            formControlName="upto"
                            class="sr-only"
                            checked
                          />
                          <div
                            class="block w-10 h-5 rounded-full bg-[var(--color-primary)]"
                          ></div>
                          <div
                            class="dot absolute left-0.5 top-0.5 w-4 h-4 rounded-full bg-white shadow-sm"
                            style="transform: translateX(20px)"
                          ></div>
                        </div>
                        <span
                          class="ml-2 text-xs font-medium text-[var(--color-font)]"
                          >Upto (Infinite)</span
                        >
                      </label>
                    </div>

                    <!-- Input Grid - 2x2 (Readonly) -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                      <!-- Min -->
                      <div>
                        <label
                          class="text-[10px] text-[var(--color-muted)] block mb-1"
                          >Min Range</label
                        >
                        <div class="relative">
                          <input
                            type="number"
                            formControlName="minRange"
                            readonly
                            class="w-full px-2 py-2 text-xs border rounded-lg bg-[var(--color-surface)]/50 text-[var(--color-muted)] border-[var(--color-border)]"
                          />
                          <span
                            class="absolute right-2 top-2 text-[10px] text-[var(--color-muted)]"
                            >₹</span
                          >
                        </div>
                      </div>
                      <!-- Max -->
                      <div>
                        <label
                          class="text-[10px] text-[var(--color-muted)] block mb-1"
                        >
                          Max Range
                        </label>
                        <div class="relative">
                          <input
                            type="text"
                            formControlName="maxRange"
                            readonly
                            value="∞"
                            class="w-full px-2 py-2 text-xs border rounded-lg bg-[var(--color-surface)]/50 text-[var(--color-primary)] font-bold border-[var(--color-border)]"
                          />
                        </div>
                      </div>
                      <!-- Qty -->
                      <div>
                        <label
                          class="text-[10px] text-[var(--color-muted)] block mb-1"
                        >
                          Quantity
                        </label>
                        <input
                          type="number"
                          formControlName="quantity"
                          readonly
                          class="w-full px-2 py-2 text-xs border rounded-lg bg-[var(--color-surface)]/50 text-[var(--color-font)] border-[var(--color-border)]"
                        />
                      </div>
                      <!-- Time -->
                      <div>
                        <label
                          class="text-[10px] text-[var(--color-muted)] block mb-1"
                        >
                          Time (min)
                        </label>
                        <input
                          type="number"
                          formControlName="time"
                          readonly
                          class="w-full px-2 py-2 text-xs border rounded-lg bg-[var(--color-surface)]/50 text-[var(--color-font)] border-[var(--color-border)]"
                        />
                      </div>
                    </div>

                    <!-- Preview -->
                    <div
                      class="pt-3 mt-1 border-t border-[var(--color-border)]"
                    >
                      <div class="flex items-center justify-between">
                        <div>
                          <span
                            class="text-[10px] text-[var(--color-muted)] block mb-1"
                            >Preview</span
                          >
                          <span
                            class="text-xs font-semibold text-[var(--color-primary)]"
                          >
                            {{ getFinalRange()?.get("minRange")?.value || 0 }} →
                            ∞
                          </span>
                        </div>
                        <div class="text-right">
                          <span
                            class="text-[10px] text-[var(--color-muted)] block mb-1"
                            >Capacity</span
                          >
                          <span
                            class="text-xs font-medium text-[var(--color-primary)]"
                          >
                            {{ getFinalRange()?.get("quantity")?.value || 0 }}
                            txns
                          </span>
                          <span
                            class="text-[10px] text-[var(--color-muted)] ml-1"
                          >
                            / {{ getFinalRange()?.get("time")?.value || 0 }} min
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Empty State for Final Range -->
                <div
                  *ngIf="!getFinalRange()"
                  class="flex flex-col items-center justify-center border-2 border-dashed border-[var(--color-border)] rounded-lg p-6 bg-[var(--color-surface)]/50 h-64"
                >
                  <span
                    class="material-icons text-[var(--color-muted)] text-3xl mb-2"
                    >infinite</span
                  >
                  <p class="text-sm font-medium text-[var(--color-muted)]">
                    No final range set
                  </p>
                  <p class="text-xs text-[var(--color-muted)] mt-1 text-center">
                    Mark any range as "upto" to set it as the final infinite
                    range
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- ========== BOTTOM: Submit Section (Full Width) ========== -->
          <div class="mt-8 pt-6 border-t border-[var(--color-border)]">
            <div
              class="flex flex-col md:flex-row items-center justify-between gap-4"
            >
              <div class="text-xs text-[var(--color-muted)]">
                <div class="flex items-center">
                  <span class="material-icons mr-1 text-sm">info</span>
                  All fields marked with
                  <span class="text-[var(--color-danger)]">*</span> are required
                </div>
                <div class="flex items-center mt-1 text-[10px]">
                  <span
                    class="material-icons mr-1 text-[10px] text-[var(--color-warning)]"
                    >warning</span
                  >
                  At least one range must be marked as "upto" before submitting
                </div>
              </div>
              <button
                type="submit"
                [disabled]="
                  isSubmitting || capacityForm.invalid || !hasUptoRange
                "
                class="px-6 py-3 bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-primary-dark)] text-[var(--color-surface)] rounded-lg text-sm font-medium hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center transition-all transform hover:scale-[1.02]"
              >
                <span *ngIf="!isSubmitting" class="flex items-center">
                  <span class="material-icons mr-1.5 text-sm">save</span>
                  Save Configuration
                </span>
                <span *ngIf="isSubmitting" class="flex items-center">
                  <span class="material-icons animate-spin mr-1.5 text-sm"
                    >refresh</span
                  >
                  Saving...
                </span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
